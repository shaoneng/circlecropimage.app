const translations = {
    en: { 
        siteName: "circlecropimage.app",
        pageTitle: "Circle Video Crop Tool - Free Online Round Video Cropper",
        metaDescription: "Crop your video into a perfect circle with our free online tool. The ideal round video cropper for creating circular profile videos, logos, and more. Supports MP4, and WEBM. No registration, instant download.",
        resetButton: "Upload New",
        howToTitle: "How It Works in 3 Simple Steps",
        step1Title: "Upload Video",
        step1Desc: "Drag and drop your video file, or click to select a video from your device.",
        step2Title: "Adjust & Record",
        step2Desc: "Drag to position the circle and use the slider to adjust its size. Click 'Start Recording' when ready.",
        step3Title: "Download",
        step3Desc: "Click the download button to instantly save your new circular video with a transparent background.",
        useCasesTitle: "Popular Ways to Use Circle Videos",
        useCase1Title: "Profile Videos",
        useCase1Desc: "Create a unique and professional look for your video profiles on social media.",
        useCase2Title: "Brand & Marketing",
        useCase2Desc: "Convert your logo or short ad into a circular video for websites or email signatures.",
        useCase3Title: "Chat Avatars",
        useCase3Desc: "Stand out in Discord, Slack, or other platforms with an animated circular avatar.",
        useCase4Title: "Design Projects",
        useCase4Desc: "Incorporate circular video clips into your web designs or presentations for a modern aesthetic.",
        featuresTitle: "Why Choose Our Tool?",
        feature1: "<strong>Completely Free:</strong> Crop as many videos as you want at no cost. No hidden fees.",
        feature2: "<strong>Privacy First:</strong> Your videos are processed in your browser and are never uploaded to our servers.",
        feature3: "<strong>Transparent Output:</strong> Download your cropped video in WEBM format with a high-quality transparent background.",
        feature4: "<strong>No Signup Needed:</strong> Use the tool instantly without creating an account.",
        feature5: "<strong>Works Everywhere:</strong> Fully responsive tool that works on desktop, tablets, and smartphones.",
        faqTitle: "Frequently Asked Questions",
        faq1q: "How do I crop a video into a circle?",
        faq1a: "Simply upload your video, use the slider to adjust the circle size, drag the circle to your desired area, and click 'Start Recording'. Once you stop, you can download the final video.",
        faq2q: "Will the final video have a transparent background?",
        faq2a: "Yes. The downloaded video will be a high-quality WEBM file with a transparent background outside the circle, making it perfect for use on any website or design project.",
        faq3q: "Is it free to use this circle crop tool?",
        faq3a: "Absolutely. Our tool is 100% free to use with no limits or watermarks. You can crop as many videos as you need.",
        faq4q: "Are my uploaded videos safe?",
        faq4a: "Yes, your privacy is our priority. The entire video processing happens in your web browser, meaning your videos are never sent to or stored on our servers.",
        privacyPolicy: "Privacy Policy",
        termsOfService: "Terms of Service",
        contactUs: "Contact Us",
        footerRights: "All rights reserved.", 
        videoMainTitle: "Circle Video Crop Tool",
        videoMainIntro: "Create perfect circular video clips online. Record any section of your video inside a circle, with a transparent background. Fast and secure.",
        uploadVideoCTA: "Drag & drop your video here, or ",
        uploadClick: "click to upload",
        uploadVideoFormats: "Supports MP4, WEBM, etc.",
        diameterLabel: "Circle Diameter:",
        videoControlsTitle: "Recording Controls",
        startRecording: "Start Recording",
        stopRecording: "Stop Recording",
        downloadTitle: "Download Your Video",
        downloadVideo: "Download Transparent Video (.webm)",
        processing: "Processing, please wait...",
        otherToolsTitle: "Other Tools",
        tool1Title: "Online Image Converter",
        tool1Desc: "Convert images to different formats like PNG, JPG, WEBP, etc.",
        tool2Title: "Video to GIF Converter",
        tool2Desc: "Easily turn your video clips into animated GIFs.",
        tool3Title: "Online Audio Cutter",
        tool3Desc: "Trim or cut audio files to the perfect length.",
        tool4Title: "Screen Recorder",
        tool4Desc: "Record your screen with audio for tutorials or presentations."
    },
    zh: { 
        siteName: "circlecropimage.app",
        pageTitle: "åœ†å½¢è§†é¢‘è£å‰ªå·¥å…· - å…è´¹åœ¨çº¿åœ†å½¢è§†é¢‘è£å‰ªå™¨",
        metaDescription: "ä½¿ç”¨æˆ‘ä»¬çš„å…è´¹åœ¨çº¿å·¥å…·å°†æ‚¨çš„è§†é¢‘è£å‰ªæˆä¸€ä¸ªå®Œç¾çš„åœ†å½¢ã€‚åˆ›å»ºåœ†å½¢ä¸ªäººèµ„æ–™è§†é¢‘ã€å¾½æ ‡ç­‰çš„ç†æƒ³åœ†å½¢è§†é¢‘è£å‰ªå™¨ã€‚æ”¯æŒMP4å’ŒWEBMã€‚æ— éœ€æ³¨å†Œï¼Œå³æ—¶ä¸‹è½½ã€‚",
        resetButton: "ä¸Šä¼ æ–°æ–‡ä»¶",
        howToTitle: "ç®€å•ä¸‰æ­¥ï¼Œè½»æ¾æå®š",
        step1Title: "ä¸Šä¼ å½±ç‰‡",
        step1Desc: "æ‹–æ”¾æ‚¨çš„å½±ç‰‡æ–‡ä»¶ï¼Œæˆ–å•å‡»ä»¥ä»æ‚¨çš„è®¾å¤‡ä¸­é€‰æ‹©å½±ç‰‡ã€‚",
        step2Title: "è°ƒæ•´ä¸å½•åˆ¶",
        step2Desc: "æ‹–åŠ¨ä»¥å®šä½åœ†å½¢ï¼Œå¹¶ä½¿ç”¨æ»‘å—è°ƒæ•´å…¶å¤§å°ã€‚å‡†å¤‡å¥½åï¼Œå•å‡»â€œå¼€å§‹å½•åˆ¶â€ã€‚",
        step3Title: "ä¸‹è½½",
        step3Desc: "å•å‡»ä¸‹è½½æŒ‰é’®ï¼Œç«‹å³ä¿å­˜æ‚¨å¸¦æœ‰é€æ˜èƒŒæ™¯çš„æ–°åœ†å½¢è§†é¢‘ã€‚",
        useCasesTitle: "åœ†å½¢å½±ç‰‡çš„å¸¸ç”¨æ–¹å¼",
        useCase1Title: "ä¸ªäººèµ„æ–™å½±ç‰‡",
        useCase1Desc: "ä¸ºæ‚¨çš„ç¤¾äº¤åª’ä½“è§†é¢‘ä¸ªäººèµ„æ–™åˆ›å»ºç‹¬ç‰¹è€Œä¸“ä¸šçš„å¤–è§‚ã€‚",
        useCase2Title: "å“ç‰Œä¸è¡Œé”€",
        useCase2Desc: "å°†æ‚¨çš„å¾½æ ‡æˆ–çŸ­å¹¿å‘Šè½¬æ¢ä¸ºåœ†å½¢è§†é¢‘ï¼Œç”¨äºç½‘ç«™æˆ–ç”µå­é‚®ä»¶ç­¾åã€‚",
        useCase3Title: "èŠå¤©å¤´åƒ",
        useCase3Desc: "åœ¨Discordã€Slackæˆ–å…¶ä»–å¹³å°ä¸Šä½¿ç”¨åŠ¨ç”»åœ†å½¢å¤´åƒè„±é¢–è€Œå‡ºã€‚",
        useCase4Title: "è®¾è®¡ä¸“æ¡ˆ",
        useCase4Desc: "å°†åœ†å½¢è§†é¢‘å‰ªè¾‘èå…¥æ‚¨çš„ç½‘é¡µè®¾è®¡æˆ–æ¼”ç¤ºæ–‡ç¨¿ä¸­ï¼Œä»¥è·å¾—ç°ä»£ç¾æ„Ÿã€‚",
        featuresTitle: "ä¸ºä»€ä¹ˆé€‰æ‹©æˆ‘ä»¬çš„å·¥å…·ï¼Ÿ",
        feature1: "<strong>å®Œå…¨å…è´¹ï¼š</strong>ä¸èŠ±ä¸€åˆ†é’±ï¼Œéšå¿ƒæ‰€æ¬²è£å‰ªä»»æ„æ•°é‡çš„å½±ç‰‡ã€‚æ— ä»»ä½•éšè—è´¹ç”¨ã€‚",
        feature2: "<strong>éšç§è‡³ä¸Šï¼š</strong>æ‚¨çš„å½±ç‰‡ç›´æ¥åœ¨æµè§ˆå™¨ä¸­å¤„ç†ï¼Œç»ä¸ä¼šä¸Šä¼ åˆ°æˆ‘ä»¬çš„æœåŠ¡å™¨ã€‚",
        feature3: "<strong>é€æ˜èƒŒæ™¯è¾“å‡ºï¼š</strong>ä»¥WEBMæ ¼å¼ä¸‹è½½æ‚¨è£å‰ªåçš„è§†é¢‘ï¼Œå¹¶å¸¦æœ‰é«˜å“è´¨çš„é€æ˜èƒŒæ™¯ã€‚",
        feature4: "<strong>æ— éœ€æ³¨å†Œï¼š</strong>æ— éœ€åˆ›å»ºå¸æˆ·ï¼Œå³åˆ»ä½¿ç”¨è¯¥å·¥å…·ã€‚",
        feature5: "<strong>éšå¤„å¯ç”¨ï¼š</strong>å®Œå…¨å“åº”å¼å·¥å…·ï¼Œå¯åœ¨å°å¼æœºã€å¹³æ¿ç”µè„‘å’Œæ™ºèƒ½æ‰‹æœºä¸Šä½¿ç”¨ã€‚",
        faqTitle: "å¸¸è§é—®é¢˜è§£ç­”",
        faq1q: "å¦‚ä½•å°†å½±ç‰‡å‰ªè£æˆåœ“å½¢ï¼Ÿ",
        faq1a: "åªéœ€ä¸Šå‚³æ‚¨çš„å½±ç‰‡ï¼Œä½¿ç”¨æ»‘æ¡¿èª¿æ•´åœ“åœˆå¤§å°ï¼Œå°‡åœ“åœˆæ‹–åˆ°æ‚¨æƒ³è¦çš„ä½ç½®ï¼Œç„¶å¾Œé»æ“Šã€Œé–‹å§‹éŒ„è£½ã€ã€‚åœæ­¢å¾Œï¼Œæ‚¨å°±å¯ä»¥ä¸‹è¼‰æœ€çµ‚çš„å½±ç‰‡ã€‚",
        faq2q: "æœ€çµ‚çš„å½±ç‰‡æœƒæœ‰é€æ˜èƒŒæ™¯å—ï¼Ÿ",
        faq2a: "æ˜¯çš„ã€‚ä¸‹è¼‰çš„å½±ç‰‡å°‡æ˜¯ä¸€å€‹é«˜å“è³ªçš„ WEBM æª”æ¡ˆï¼Œåœ“åœˆå¤–éƒ¨å¸¶æœ‰é€æ˜èƒŒæ™¯ï¼Œéå¸¸é©åˆåœ¨ä»»ä½•ç¶²ç«™æˆ–è¨­è¨ˆå°ˆæ¡ˆä¸­ä½¿ç”¨ã€‚",
        faq3q: "è¿™ä¸ªåœ†å½¢è£å‰ªå·¥å…·æ˜¯å…è´¹çš„å—ï¼Ÿ",
        faq3a: "å®Œå…¨å…è´¹ã€‚æˆ‘ä»¬çš„å·¥å…·100%å…è´¹ä½¿ç”¨ï¼Œæ²¡æœ‰é™åˆ¶æˆ–æ°´å°ã€‚æ‚¨å¯ä»¥æ ¹æ®éœ€è¦è£å‰ªä»»æ„æ•°é‡çš„å½±ç‰‡ã€‚",
        faq4q: "æˆ‘ä¸Šä¼ çš„å½±ç‰‡å®‰å…¨å—ï¼Ÿ",
        faq4a: "æ˜¯çš„ï¼Œæ‚¨çš„éšç§æ˜¯æˆ‘ä»¬çš„é¦–è¦ä»»åŠ¡ã€‚æ•´ä¸ªå½±ç‰‡å¤„ç†è¿‡ç¨‹éƒ½åœ¨æ‚¨çš„ç½‘ç»œæµè§ˆå™¨ä¸­è¿›è¡Œï¼Œè¿™æ„å‘³ç€æ‚¨çš„å½±ç‰‡æ°¸è¿œä¸ä¼šå‘é€åˆ°æˆ–å­˜å‚¨åœ¨æˆ‘ä»¬çš„æœåŠ¡å™¨ä¸Šã€‚",
        privacyPolicy: "éšç§æ”¿ç­–",
        termsOfService: "æœåŠ¡æ¡æ¬¾",
        contactUs: "è”ç³»æˆ‘ä»¬",
        footerRights: "ç‰ˆæƒæ‰€æœ‰ã€‚",
        videoMainTitle: "åœ†å½¢è§†é¢‘è£å‰ªå·¥å…·",
        videoMainIntro: "åœ¨çº¿åˆ¶ä½œå®Œç¾çš„åœ†å½¢è§†é¢‘å‰ªè¾‘ã€‚åœ¨åœ†åœˆå†…å½•åˆ¶è§†é¢‘çš„ä»»ä½•éƒ¨åˆ†ï¼ŒèƒŒæ™¯é€æ˜ï¼Œå¿«é€Ÿä¸”å®‰å…¨ã€‚",
        uploadVideoCTA: "å°†è§†é¢‘æ‹–æ”¾åˆ°æ­¤å¤„ï¼Œæˆ– ",
        uploadClick: "ç‚¹å‡»ä¸Šä¼ ",
        uploadVideoFormats: "æ”¯æŒ MP4, WEBM ç­‰æ ¼å¼ã€‚",
        diameterLabel: "åœ†å½¢ç›´å¾„:",
        videoControlsTitle: "å½•åˆ¶æ§åˆ¶",
        startRecording: "å¼€å§‹å½•åˆ¶",
        stopRecording: "åœæ­¢å½•åˆ¶",
        downloadTitle: "ä¸‹è½½æ‚¨çš„è§†é¢‘",
        downloadVideo: "ä¸‹è½½é€æ˜èƒŒæ™¯å½±ç‰‡ (.webm)",
        processing: "å¤„ç†ä¸­ï¼Œè¯·ç¨å€™...",
        otherToolsTitle: "å…¶ä»–å·¥å…·",
        tool1Title: "åœ¨çº¿å›¾ç‰‡è½¬æ¢å™¨",
        tool1Desc: "å°†å›¾ç‰‡è½¬æ¢ä¸ºPNGã€JPGã€WEBPç­‰ä¸åŒæ ¼å¼ã€‚",
        tool2Title: "è§†é¢‘è½¬GIFè½¬æ¢å™¨",
        tool2Desc: "è½»æ¾å°†æ‚¨çš„è§†é¢‘å‰ªè¾‘è½¬æ¢ä¸ºåŠ¨ç”»GIFã€‚",
        tool3Title: "åœ¨çº¿éŸ³é¢‘å‰ªåˆ‡å™¨",
        tool3Desc: "ä¿®å‰ªæˆ–å‰ªåˆ‡éŸ³é¢‘æ–‡ä»¶è‡³å®Œç¾é•¿åº¦ã€‚",
        tool4Title: "å±å¹•å½•åƒæœº",
        tool4Desc: "å½•åˆ¶æ‚¨çš„å±å¹•å’ŒéŸ³é¢‘ï¼Œç”¨äºæ•™ç¨‹æˆ–æ¼”ç¤ºã€‚"
    },
    // Other languages are omitted for brevity but would follow the same structure.
    es: { 
        siteName: "circlecropimage.app",
        pageTitle: "Herramienta de Recorte de Video Circular - Recortador de Video Redondo en LÃ­nea Gratuito",
        metaDescription: "Recorte su video en un cÃ­rculo perfecto con nuestra herramienta en lÃ­nea gratuita. El recortador de video redondo ideal para crear videos de perfil circulares, logotipos y mÃ¡s. Admite MP4 y WEBM. Sin registro, descarga instantÃ¡nea.",
        resetButton: "Subir Nuevo",
        howToTitle: "CÃ³mo Funciona en 3 Pasos Simples",
        step1Title: "Subir Video",
        step1Desc: "Arrastre y suelte su archivo de video, o haga clic para seleccionar un video de su dispositivo.",
        step2Title: "Ajustar y Grabar",
        step2Desc: "Arrastre para posicionar el cÃ­rculo y use el control deslizante para ajustar su tamaÃ±o. Haga clic en 'Iniciar GrabaciÃ³n' cuando estÃ© listo.",
        step3Title: "Descargar",
        step3Desc: "Haga clic en el botÃ³n de descarga para guardar instantÃ¡neamente su nuevo video circular con un fondo transparente.",
        useCasesTitle: "Formas Populares de Usar Videos Circulares",
        useCase1Title: "Videos de Perfil",
        useCase1Desc: "Cree una apariencia Ãºnica y profesional para sus perfiles de video en las redes sociales.",
        useCase2Title: "Marca y Marketing",
        useCase2Desc: "Convierta su logotipo o anuncio corto en un video circular para sitios web o firmas de correo electrÃ³nico.",
        useCase3Title: "Avatares de Chat",
        useCase3Desc: "Destaque en Discord, Slack u otras plataformas con un avatar circular animado.",
        useCase4Title: "Proyectos de DiseÃ±o",
        useCase4Desc: "Incorpore videoclips circulares en sus diseÃ±os web o presentaciones para una estÃ©tica moderna.",
        featuresTitle: "Â¿Por QuÃ© Elegir Nuestra Herramienta?",
        feature1: "<strong>Totalmente Gratis:</strong> Recorta tantos videos como quieras sin coste alguno. Sin cargos ocultos.",
        feature2: "<strong>Privacidad Primero:</strong> Sus videos se procesan en su navegador y nunca se suben a nuestros servidores.",
        feature3: "<strong>Salida Transparente:</strong> Descargue su video recortado en formato WEBM con un fondo transparente de alta calidad.",
        feature4: "<strong>Sin Registro:</strong> Use la herramienta al instante sin necesidad de crear una cuenta.",
        feature5: "<strong>Funciona en Todas Partes:</strong> Herramienta totalmente adaptable que funciona en ordenadores, tabletas y mÃ³viles.",
        faqTitle: "Preguntas Frecuentes",
        faq1q: "Â¿CÃ³mo recorto un video en un cÃ­rculo?",
        faq1a: "Simplemente suba su video, use el control deslizante para ajustar el tamaÃ±o del cÃ­rculo, arrastre el cÃ­rculo al Ã¡rea deseada y haga clic en 'Iniciar grabaciÃ³n'. Una vez que se detenga, puede descargar el video final.",
        faq2q: "Â¿El video final tendrÃ¡ un fondo transparente?",
        faq2a: "SÃ­. El video descargado serÃ¡ un archivo WEBM de alta calidad con un fondo transparente fuera del cÃ­rculo, lo que lo hace perfecto para usar en cualquier sitio web o proyecto de diseÃ±o.",
        faq3q: "Â¿Es gratis usar esta herramienta de recorte circular?",
        faq3a: "Absolutamente. Nuestra herramienta es 100% gratuita, sin lÃ­mites ni marcas de agua. Puedes recortar tantos videos como necesites.",
        faq4q: "Â¿EstÃ¡n seguros mis videos subidos?",
        faq4a: "SÃ­, su privacidad es nuestra prioridad. Todo el procesamiento de video ocurre en su navegador web, lo que significa que sus videos nunca se envÃ­an ni se almacenan en nuestros servidores.",
        privacyPolicy: "PolÃ­tica de Privacidad",
        termsOfService: "TÃ©rminos de Servicio",
        contactUs: "ContÃ¡ctanos",
        footerRights: "Todos los derechos reservados.",
        videoMainTitle: "Herramienta de Recorte de Video Circular",
        videoMainIntro: "Cree videoclips circulares perfectos en lÃ­nea. Grabe cualquier secciÃ³n de su video dentro de un cÃ­rculo, con un fondo transparente. RÃ¡pido y seguro.",
        uploadVideoCTA: "Arrastre y suelte su video aquÃ­, o ",
        uploadClick: "clic para subir",
        uploadVideoFormats: "Admite MP4, WEBM, etc.",
        diameterLabel: "DiÃ¡metro del cÃ­rculo:",
        videoControlsTitle: "Controles de GrabaciÃ³n",
        startRecording: "Iniciar GrabaciÃ³n",
        stopRecording: "Detener GrabaciÃ³n",
        downloadTitle: "Descargue su video",
        downloadVideo: "Descargar video transparente (.webm)",
        processing: "Procesando, por favor espere...",
        otherToolsTitle: "Otras Herramientas",
        tool1Title: "Convertidor de ImÃ¡genes en LÃ­nea",
        tool1Desc: "Convierta imÃ¡genes a diferentes formatos como PNG, JPG, WEBP, etc.",
        tool2Title: "Convertidor de Video a GIF",
        tool2Desc: "Convierta fÃ¡cilmente sus videoclips en GIF animados.",
        tool3Title: "Cortador de Audio en LÃ­nea",
        tool3Desc: "Recorte o corte archivos de audio a la longitud perfecta.",
        tool4Title: "Grabador de Pantalla",
        tool4Desc: "Grabe su pantalla con audio para tutoriales o presentaciones."
    }
};
const flags = { en: 'ğŸ‡ºğŸ‡¸', es: 'ğŸ‡ªğŸ‡¸', pt: 'ğŸ‡§ğŸ‡·', ru: 'ğŸ‡·ğŸ‡º', de: 'ğŸ‡©ğŸ‡ª', fr: 'ğŸ‡«ğŸ‡·', ja: 'ğŸ‡¯ğŸ‡µ', ko: 'ğŸ‡°ğŸ‡·', zh: 'ğŸ‡¨ğŸ‡³' };
let currentLang = 'en';
function updateNavLinks(e){document.querySelectorAll(".nav-link").forEach(t=>{const n=t.getAttribute("href").split("?")[0],o="/index.html"===n||"/"===n?"/":n;t.setAttribute("href",`${o}?lang=${e}`)})}
function setLanguage(e){const t=translations[e]?e:"en";currentLang=t;const n=translations[t]||translations.en;document.querySelectorAll("[data-lang-key]").forEach(e=>{const t=e.getAttribute("data-lang-key");n[t]&&(e.innerHTML=n[t])}),document.title=n.pageTitle,document.querySelector('meta[name="description"]').setAttribute("content",n.metaDescription),document.documentElement.lang=t;const o=document.getElementById("current-lang-flag");o&&(o.textContent=flags[t]);const a=document.getElementById("lang-switcher-menu");a&&a.classList.add("hidden","opacity-0","scale-95"),updateNavLinks(t)}
document.addEventListener("DOMContentLoaded",function(){const e=document.getElementById("lang-switcher-btn"),t=document.getElementById("lang-switcher-menu");let n="<div class='py-1' role='menu' aria-orientation='vertical' aria-labelledby='options-menu'>";const o={en:"English",es:"EspaÃ±ol",pt:"PortuguÃªs",ru:"Ğ ÑƒÑÑĞºĞ¸Ğ¹",de:"Deutsch",fr:"FranÃ§ais",ja:"æ—¥æœ¬èª",ko:"í•œêµ­ì–´",zh:"ä¸­æ–‡ (ç®€ä½“)"};for(const a in flags)n+=`<a href="?lang=${a}" class="flex items-center px-4 py-2 text-sm text-gray-700 hover:bg-gray-100" role="menuitem" data-lang="${a}"><span class="mr-3">${flags[a]}</span> ${o[a]}</a>`;n+="</div>",t.innerHTML=n,e.addEventListener("click",()=>{t.classList.toggle("hidden"),setTimeout(()=>{t.classList.toggle("opacity-0"),t.classList.toggle("scale-95")},10),e.setAttribute("aria-expanded",!t.classList.contains("hidden"))}),document.addEventListener("click",n=>{!e.contains(n.target)&&!t.contains(n.target)&&(t.classList.add("hidden","opacity-0","scale-95"),e.setAttribute("aria-expanded","false"))}),t.addEventListener("click",e=>{e.preventDefault();const n=e.target.closest("a");if(n&&n.dataset.lang){const e=n.dataset.lang;setLanguage(e);try{const t=new URL(window.location);t.searchParams.set("lang",e),window.history.pushState({},"",t)}catch(e){console.warn("Could not update URL with pushState.",e)}}});const a=new URLSearchParams(window.location.search),l=a.get("lang")||"en";setLanguage(l),document.getElementById("footer-year").textContent=(new Date).getFullYear();

// --- VIDEO CROPPER LOGIC ---
const videoUploadContainer = document.getElementById('video-upload-container');
const videoDropArea = document.getElementById('video-drop-area');
const videoFileInput = document.getElementById('video-file-input');
const videoEditorContainer = document.getElementById('video-editor-container');
const videoPlayer = document.getElementById('video-player');
const videoWrapper = document.querySelector('.canvas-wrapper');
const guideCanvas = document.getElementById('video-guide-canvas');
const guideCtx = guideCanvas.getContext('2d');
const diameterSlider = document.getElementById('diameter-slider');
const videoControlsContainer = document.getElementById('video-controls-container');
const startRecBtn = document.getElementById('start-rec-btn');
const stopRecBtn = document.getElementById('stop-rec-btn');
const videoResetBtn = document.getElementById('video-reset-btn');
const videoResetBtn2 = document.getElementById('video-reset-btn-2');
const videoResultContainer = document.getElementById('video-result-container');
const downloadVideoBtn = document.getElementById('download-video-btn');
const processingNotice = document.getElementById('video-processing-notice');

let videoFile = null;
let webmRecorder;
let webmChunks = [];
let animationFrameId;
let recordingTimerInterval = null;

let circlePosition = { x: 0, y: 0 };
let isDragging = false;
let dragStart = { x: 0, y: 0 };

function handleVideoUpload(file) {
    if (file && file.type.startsWith('video/')) {
        videoFile = file;
        videoPlayer.src = URL.createObjectURL(videoFile);
        videoUploadContainer.classList.add('hidden');
        videoEditorContainer.classList.remove('hidden');
        videoControlsContainer.classList.remove('hidden');
        videoResultContainer.classList.add('hidden');
    }
}

function drawVideoGuide() {
    const diam = parseInt(diameterSlider.value, 10);
    const radius = diam / 2;
    const centerX = (guideCanvas.width / 2) + circlePosition.x;
    const centerY = (guideCanvas.height / 2) + circlePosition.y;
    
    guideCtx.clearRect(0, 0, guideCanvas.width, guideCanvas.height);
    guideCtx.fillStyle = 'rgba(0, 0, 0, 0.5)';
    guideCtx.beginPath();
    guideCtx.rect(0, 0, guideCanvas.width, guideCanvas.height);
    guideCtx.arc(centerX, centerY, radius, 0, Math.PI * 2, true);
    guideCtx.fill();

    guideCtx.strokeStyle = 'rgba(255, 255, 255, 0.8)';
    guideCtx.lineWidth = 2;
    guideCtx.beginPath();
    guideCtx.arc(centerX, centerY, radius, 0, Math.PI * 2);
    guideCtx.stroke();
}

function formatTime(ms) {
    const seconds = Math.floor(ms / 1000);
    const ss = String(seconds % 60).padStart(2, '0');
    const mm = String(Math.floor(seconds / 60)).padStart(2, '0');
    return `${mm}:${ss}`;
}

videoPlayer.addEventListener('loadedmetadata', () => {
    const aspect = videoPlayer.videoWidth / videoPlayer.videoHeight;
    const containerWidth = videoPlayer.parentElement.clientWidth;
    guideCanvas.width = containerWidth;
    guideCanvas.height = containerWidth / aspect;
    diameterSlider.max = Math.min(guideCanvas.width, guideCanvas.height);
    diameterSlider.value = diameterSlider.max * 0.8;
    drawVideoGuide();
    videoPlayer.play();
});

function startRecording() {
    startRecBtn.classList.add('hidden');
    stopRecBtn.classList.remove('hidden');
    processingNotice.classList.add('hidden');
    videoResultContainer.classList.add('hidden');
    diameterSlider.disabled = true;

    const diam = parseInt(diameterSlider.value, 10);
    const transCanvas = document.createElement('canvas');
    transCanvas.width = diam;
    transCanvas.height = diam;
    const transCtx = transCanvas.getContext('2d');

    function renderLoop() {
        const scale = videoPlayer.videoWidth / guideCanvas.width;
        const radiusInVideoPixels = (diam / 2) * scale;
        const centerXInVideoPixels = (videoPlayer.videoWidth / 2) + (circlePosition.x * scale);
        const centerYInVideoPixels = (videoPlayer.videoHeight / 2) + (circlePosition.y * scale);
        const sx = centerXInVideoPixels - radiusInVideoPixels;
        const sy = centerYInVideoPixels - radiusInVideoPixels;
        const sWidth = 2 * radiusInVideoPixels;
        const sHeight = sWidth;
        transCtx.clearRect(0, 0, diam, diam);
        transCtx.save();
        transCtx.beginPath();
        transCtx.arc(diam / 2, diam / 2, diam / 2, 0, Math.PI * 2);
        transCtx.clip();
        transCtx.drawImage(videoPlayer, sx, sy, sWidth, sHeight, 0, 0, diam, diam);
        transCtx.restore();
        animationFrameId = requestAnimationFrame(renderLoop);
    }

    let audioStream = null;
    if (videoPlayer.mozCaptureStream) {
        audioStream = videoPlayer.mozCaptureStream().getAudioTracks().length > 0 ? new MediaStream(videoPlayer.mozCaptureStream().getAudioTracks()) : null;
    } else if (videoPlayer.captureStream) {
         audioStream = videoPlayer.captureStream().getAudioTracks().length > 0 ? new MediaStream(videoPlayer.captureStream().getAudioTracks()) : null;
    }
    const transStream = transCanvas.captureStream(30);
    if(audioStream && audioStream.getAudioTracks().length > 0) {
      const transAudioTrack = audioStream.getAudioTracks()[0].clone();
      transStream.addTrack(transAudioTrack);
    }
    webmRecorder = new MediaRecorder(transStream, { mimeType: 'video/webm; codecs=vp9,opus' });
    webmChunks = [];
    webmRecorder.ondataavailable = e => webmChunks.push(e.data);

    webmRecorder.onstop = () => {
        const blob = new Blob(webmChunks, { type: 'video/webm' });
        const url = URL.createObjectURL(blob);
        const originalFilename = videoFile.name;
        const baseFilename = originalFilename.lastIndexOf('.') > 0 ? originalFilename.substring(0, originalFilename.lastIndexOf('.')) : originalFilename;
        downloadVideoBtn.href = url;
        downloadVideoBtn.download = `${baseFilename}-circle.webm`;
    };
    
    videoPlayer.pause();
    videoPlayer.currentTime = 0;
    webmRecorder.start();
    videoPlayer.play();
    renderLoop();

    const startTime = Date.now();
    const originalStopText = translations[currentLang].stopRecording;
    recordingTimerInterval = setInterval(() => {
        const elapsedTime = Date.now() - startTime;
        stopRecBtn.textContent = `${originalStopText} (${formatTime(elapsedTime)})`;
    }, 1000);
}

function stopRecording() {
    if (recordingTimerInterval) {
        clearInterval(recordingTimerInterval);
        recordingTimerInterval = null;
    }
    stopRecBtn.textContent = translations[currentLang].stopRecording;

    if(videoPlayer.played) videoPlayer.pause();
    if (webmRecorder && webmRecorder.state !== "inactive") webmRecorder.stop();
    cancelAnimationFrame(animationFrameId);
    stopRecBtn.classList.add('hidden');
    startRecBtn.classList.remove('hidden');
    videoControlsContainer.classList.add('hidden');
    videoResultContainer.classList.remove('hidden');
    processingNotice.classList.remove('hidden');
    setTimeout(() => processingNotice.classList.add('hidden'), 2000);
    diameterSlider.disabled = false;
}

function resetVideoTool() {
    stopRecording();
    if(videoPlayer.src) {
        URL.revokeObjectURL(videoPlayer.src);
        videoPlayer.src = "";
    }
    videoFile = null;
    videoFileInput.value = "";
    videoUploadContainer.classList.remove('hidden');
    videoEditorContainer.classList.add('hidden');
    videoControlsContainer.classList.add('hidden');
    videoResultContainer.classList.add('hidden');
    if (downloadVideoBtn.href) URL.revokeObjectURL(downloadVideoBtn.href);
    downloadVideoBtn.href = "#";
    diameterSlider.disabled = false;
    circlePosition = { x: 0, y: 0 };
}

videoPlayer.onended = stopRecording;
videoDropArea.addEventListener('click', () => videoFileInput.click());
videoDropArea.addEventListener('keydown', e => { if (e.key === 'Enter' || e.key === ' ') videoFileInput.click(); });
videoFileInput.addEventListener('change', (e) => handleVideoUpload(e.target.files[0]));
videoDropArea.addEventListener('dragover', e => { e.preventDefault(); e.stopPropagation(); videoDropArea.classList.add('drag-over'); });
videoDropArea.addEventListener('dragleave', e => { e.preventDefault(); e.stopPropagation(); videoDropArea.classList.remove('drag-over'); });
videoDropArea.addEventListener('drop', e => { e.preventDefault(); e.stopPropagation(); videoDropArea.classList.remove('drag-over'); handleVideoUpload(e.dataTransfer.files[0]); });

diameterSlider.addEventListener('input', () => {
    drawVideoGuide();
});

startRecBtn.addEventListener('click', startRecording);
stopRecBtn.addEventListener('click', stopRecording);
videoResetBtn.addEventListener('click', resetVideoTool);
videoResetBtn2.addEventListener('click', resetVideoTool);

function getMousePos(canvas, evt) {
    const rect = canvas.getBoundingClientRect();
    const clientX = evt.clientX || (evt.touches && evt.touches[0].clientX);
    const clientY = evt.clientY || (evt.touches && evt.touches[0].clientY);
    return {
        x: clientX - rect.left,
        y: clientY - rect.top
    };
}

function handleDragStart(evt) {
    evt.preventDefault();
    const clickPos = getMousePos(guideCanvas, evt);
    const radius = parseInt(diameterSlider.value, 10) / 2;
    const centerX = (guideCanvas.width / 2) + circlePosition.x;
    const centerY = (guideCanvas.height / 2) + circlePosition.y;
    const dx = clickPos.x - centerX;
    const dy = clickPos.y - centerY;
    if (dx * dx + dy * dy <= radius * radius) {
        isDragging = true;
        dragStart = getMousePos(guideCanvas, evt);
        videoWrapper.classList.add('is-dragging');
    }
}

function handleDragMove(evt) {
    if (!isDragging) return;
    evt.preventDefault();
    const pos = getMousePos(guideCanvas, evt);
    const dx = pos.x - dragStart.x;
    const dy = pos.y - dragStart.y;
    
    circlePosition.x += dx;
    circlePosition.y += dy;

    const radius = parseInt(diameterSlider.value, 10) / 2;
    const maxX = (guideCanvas.width / 2) - radius;
    const maxY = (guideCanvas.height / 2) - radius;
    
    circlePosition.x = Math.max(-maxX, Math.min(maxX, circlePosition.x));
    circlePosition.y = Math.max(-maxY, Math.min(maxY, circlePosition.y));
    
    dragStart = pos;
    drawVideoGuide();
}

function handleDragEnd() {
    isDragging = false;
    videoWrapper.classList.remove('is-dragging');
}

guideCanvas.addEventListener('mousemove', (evt) => {
    if(isDragging) return;
    const pos = getMousePos(guideCanvas, evt);
    const radius = parseInt(diameterSlider.value, 10) / 2;
    const centerX = (guideCanvas.width / 2) + circlePosition.x;
    const centerY = (guideCanvas.height / 2) + circlePosition.y;
    const dx = pos.x - centerX;
    const dy = pos.y - centerY;
    if (dx * dx + dy * dy <= radius * radius) {
        guideCanvas.style.cursor = 'move';
    } else {
        guideCanvas.style.cursor = 'default';
    }
});

guideCanvas.addEventListener('mouseleave', () => {
    guideCanvas.style.cursor = 'default';
});

guideCanvas.addEventListener('mousedown', handleDragStart);
guideCanvas.addEventListener('touchstart', handleDragStart, { passive: false });

document.addEventListener('mousemove', handleDragMove);
document.addEventListener('touchmove', handleDragMove, { passive: false });

document.addEventListener('mouseup', handleDragEnd);
document.addEventListener('touchend', handleDragEnd);

});