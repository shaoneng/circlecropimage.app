const translations = {
    en: { 
        siteName: "circlecropimage.app",
        pageTitle: "Circle Video Crop Tool - Free Online Round Video Cropper",
        metaDescription: "Crop your video into a perfect circle with our free online tool. The ideal round video cropper for creating circular profile videos, logos, and more. Supports MP4, and WEBM. No registration, instant download.",
        resetButton: "Upload New",
        howToTitle: "How It Works in 3 Simple Steps",
        step1Title: "Upload Video",
        step1Desc: "Drag and drop your video file, or click to select a video from your device.",
        step2Title: "Adjust & Record",
        step2Desc: "Drag to position the circle and use the slider to adjust its size. Click 'Start Recording' when ready.",
        step3Title: "Download",
        step3Desc: "Click the download button to instantly save your new circular video with a transparent background.",
        useCasesTitle: "Popular Ways to Use Circle Videos",
        useCase1Title: "Profile Videos",
        useCase1Desc: "Create a unique and professional look for your video profiles on social media.",
        useCase2Title: "Brand & Marketing",
        useCase2Desc: "Convert your logo or short ad into a circular video for websites or email signatures.",
        useCase3Title: "Chat Avatars",
        useCase3Desc: "Stand out in Discord, Slack, or other platforms with an animated circular avatar.",
        useCase4Title: "Design Projects",
        useCase4Desc: "Incorporate circular video clips into your web designs or presentations for a modern aesthetic.",
        featuresTitle: "Why Choose Our Tool?",
        feature1: "<strong>Completely Free:</strong> Crop as many videos as you want at no cost. No hidden fees.",
        feature2: "<strong>Privacy First:</strong> Your videos are processed in your browser and are never uploaded to our servers.",
        feature3: "<strong>Transparent Output:</strong> Download your cropped video in WEBM format with a high-quality transparent background.",
        feature4: "<strong>No Signup Needed:</strong> Use the tool instantly without creating an account.",
        feature5: "<strong>Works Everywhere:</strong> Fully responsive tool that works on desktop, tablets, and smartphones.",
        faqTitle: "Frequently Asked Questions",
        faq1q: "How do I crop a video into a circle?",
        faq1a: "Simply upload your video, use the slider to adjust the circle size, drag the circle to your desired area, and click 'Start Recording'. Once you stop, you can download the final video.",
        faq2q: "Will the final video have a transparent background?",
        faq2a: "Yes. The downloaded video will be a high-quality WEBM file with a transparent background outside the circle, making it perfect for use on any website or design project.",
        faq3q: "Is it free to use this circle crop tool?",
        faq3a: "Absolutely. Our tool is 100% free to use with no limits or watermarks. You can crop as many videos as you need.",
        faq4q: "Are my uploaded videos safe?",
        faq4a: "Yes, your privacy is our priority. The entire video processing happens in your web browser, meaning your videos are never sent to or stored on our servers.",
        privacyPolicy: "Privacy Policy",
        termsOfService: "Terms of Service",
        contactUs: "Contact Us",
        footerRights: "All rights reserved.", 
        videoMainTitle: "Circle Video Crop Tool",
        videoMainIntro: "Create perfect circular video clips online. Record any section of your video inside a circle, with a transparent background. Fast and secure.",
        uploadVideoCTA: "Drag & drop your video here, or ",
        uploadClick: "click to upload",
        uploadVideoFormats: "Supports MP4, WEBM, etc.",
        diameterLabel: "Circle Diameter:",
        videoControlsTitle: "Recording Controls",
        startRecording: "Start Recording",
        stopRecording: "Stop Recording",
        downloadTitle: "Download Your Video",
        downloadVideo: "Download Transparent Video (.webm)",
        processing: "Processing, please wait...",
        otherToolsTitle: "Other Tools",
        tool1Title: "Online Image Converter",
        tool1Desc: "Convert images to different formats like PNG, JPG, WEBP, etc.",
        tool2Title: "Video to GIF Converter",
        tool2Desc: "Easily turn your video clips into animated GIFs.",
        tool3Title: "Online Audio Cutter",
        tool3Desc: "Trim or cut audio files to the perfect length.",
        tool4Title: "Screen Recorder",
        tool4Desc: "Record your screen with audio for tutorials or presentations."
    },
    zh: { 
        siteName: "circlecropimage.app",
        pageTitle: "圆形视频裁剪工具 - 免费在线圆形视频裁剪器",
        metaDescription: "使用我们的免费在线工具将您的视频裁剪成一个完美的圆形。创建圆形个人资料视频、徽标等的理想圆形视频裁剪器。支持MP4和WEBM。无需注册，即时下载。",
        resetButton: "上传新文件",
        howToTitle: "简单三步，轻松搞定",
        step1Title: "上传影片",
        step1Desc: "拖放您的影片文件，或单击以从您的设备中选择影片。",
        step2Title: "调整与录制",
        step2Desc: "拖动以定位圆形，并使用滑块调整其大小。准备好后，单击“开始录制”。",
        step3Title: "下载",
        step3Desc: "单击下载按钮，立即保存您带有透明背景的新圆形视频。",
        useCasesTitle: "圆形影片的常用方式",
        useCase1Title: "个人资料影片",
        useCase1Desc: "为您的社交媒体视频个人资料创建独特而专业的外观。",
        useCase2Title: "品牌与行销",
        useCase2Desc: "将您的徽标或短广告转换为圆形视频，用于网站或电子邮件签名。",
        useCase3Title: "聊天头像",
        useCase3Desc: "在Discord、Slack或其他平台上使用动画圆形头像脱颖而出。",
        useCase4Title: "设计专案",
        useCase4Desc: "将圆形视频剪辑融入您的网页设计或演示文稿中，以获得现代美感。",
        featuresTitle: "为什么选择我们的工具？",
        feature1: "<strong>完全免费：</strong>不花一分钱，随心所欲裁剪任意数量的影片。无任何隐藏费用。",
        feature2: "<strong>隐私至上：</strong>您的影片直接在浏览器中处理，绝不会上传到我们的服务器。",
        feature3: "<strong>透明背景输出：</strong>以WEBM格式下载您裁剪后的视频，并带有高品质的透明背景。",
        feature4: "<strong>无需注册：</strong>无需创建帐户，即刻使用该工具。",
        feature5: "<strong>随处可用：</strong>完全响应式工具，可在台式机、平板电脑和智能手机上使用。",
        faqTitle: "常见问题解答",
        faq1q: "如何将影片剪裁成圓形？",
        faq1a: "只需上傳您的影片，使用滑桿調整圓圈大小，將圓圈拖到您想要的位置，然後點擊「開始錄製」。停止後，您就可以下載最終的影片。",
        faq2q: "最終的影片會有透明背景嗎？",
        faq2a: "是的。下載的影片將是一個高品質的 WEBM 檔案，圓圈外部帶有透明背景，非常適合在任何網站或設計專案中使用。",
        faq3q: "这个圆形裁剪工具是免费的吗？",
        faq3a: "完全免费。我们的工具100%免费使用，没有限制或水印。您可以根据需要裁剪任意数量的影片。",
        faq4q: "我上传的影片安全吗？",
        faq4a: "是的，您的隐私是我们的首要任务。整个影片处理过程都在您的网络浏览器中进行，这意味着您的影片永远不会发送到或存储在我们的服务器上。",
        privacyPolicy: "隐私政策",
        termsOfService: "服务条款",
        contactUs: "联系我们",
        footerRights: "版权所有。",
        videoMainTitle: "圆形视频裁剪工具",
        videoMainIntro: "在线制作完美的圆形视频剪辑。在圆圈内录制视频的任何部分，背景透明，快速且安全。",
        uploadVideoCTA: "将视频拖放到此处，或 ",
        uploadClick: "点击上传",
        uploadVideoFormats: "支持 MP4, WEBM 等格式。",
        diameterLabel: "圆形直径:",
        videoControlsTitle: "录制控制",
        startRecording: "开始录制",
        stopRecording: "停止录制",
        downloadTitle: "下载您的视频",
        downloadVideo: "下载透明背景影片 (.webm)",
        processing: "处理中，请稍候...",
        otherToolsTitle: "其他工具",
        tool1Title: "在线图片转换器",
        tool1Desc: "将图片转换为PNG、JPG、WEBP等不同格式。",
        tool2Title: "视频转GIF转换器",
        tool2Desc: "轻松将您的视频剪辑转换为动画GIF。",
        tool3Title: "在线音频剪切器",
        tool3Desc: "修剪或剪切音频文件至完美长度。",
        tool4Title: "屏幕录像机",
        tool4Desc: "录制您的屏幕和音频，用于教程或演示。"
    },
    // Other languages are omitted for brevity but would follow the same structure.
    es: { 
        siteName: "circlecropimage.app",
        pageTitle: "Herramienta de Recorte de Video Circular - Recortador de Video Redondo en Línea Gratuito",
        metaDescription: "Recorte su video en un círculo perfecto con nuestra herramienta en línea gratuita. El recortador de video redondo ideal para crear videos de perfil circulares, logotipos y más. Admite MP4 y WEBM. Sin registro, descarga instantánea.",
        resetButton: "Subir Nuevo",
        howToTitle: "Cómo Funciona en 3 Pasos Simples",
        step1Title: "Subir Video",
        step1Desc: "Arrastre y suelte su archivo de video, o haga clic para seleccionar un video de su dispositivo.",
        step2Title: "Ajustar y Grabar",
        step2Desc: "Arrastre para posicionar el círculo y use el control deslizante para ajustar su tamaño. Haga clic en 'Iniciar Grabación' cuando esté listo.",
        step3Title: "Descargar",
        step3Desc: "Haga clic en el botón de descarga para guardar instantáneamente su nuevo video circular con un fondo transparente.",
        useCasesTitle: "Formas Populares de Usar Videos Circulares",
        useCase1Title: "Videos de Perfil",
        useCase1Desc: "Cree una apariencia única y profesional para sus perfiles de video en las redes sociales.",
        useCase2Title: "Marca y Marketing",
        useCase2Desc: "Convierta su logotipo o anuncio corto en un video circular para sitios web o firmas de correo electrónico.",
        useCase3Title: "Avatares de Chat",
        useCase3Desc: "Destaque en Discord, Slack u otras plataformas con un avatar circular animado.",
        useCase4Title: "Proyectos de Diseño",
        useCase4Desc: "Incorpore videoclips circulares en sus diseños web o presentaciones para una estética moderna.",
        featuresTitle: "¿Por Qué Elegir Nuestra Herramienta?",
        feature1: "<strong>Totalmente Gratis:</strong> Recorta tantos videos como quieras sin coste alguno. Sin cargos ocultos.",
        feature2: "<strong>Privacidad Primero:</strong> Sus videos se procesan en su navegador y nunca se suben a nuestros servidores.",
        feature3: "<strong>Salida Transparente:</strong> Descargue su video recortado en formato WEBM con un fondo transparente de alta calidad.",
        feature4: "<strong>Sin Registro:</strong> Use la herramienta al instante sin necesidad de crear una cuenta.",
        feature5: "<strong>Funciona en Todas Partes:</strong> Herramienta totalmente adaptable que funciona en ordenadores, tabletas y móviles.",
        faqTitle: "Preguntas Frecuentes",
        faq1q: "¿Cómo recorto un video en un círculo?",
        faq1a: "Simplemente suba su video, use el control deslizante para ajustar el tamaño del círculo, arrastre el círculo al área deseada y haga clic en 'Iniciar grabación'. Una vez que se detenga, puede descargar el video final.",
        faq2q: "¿El video final tendrá un fondo transparente?",
        faq2a: "Sí. El video descargado será un archivo WEBM de alta calidad con un fondo transparente fuera del círculo, lo que lo hace perfecto para usar en cualquier sitio web o proyecto de diseño.",
        faq3q: "¿Es gratis usar esta herramienta de recorte circular?",
        faq3a: "Absolutamente. Nuestra herramienta es 100% gratuita, sin límites ni marcas de agua. Puedes recortar tantos videos como necesites.",
        faq4q: "¿Están seguros mis videos subidos?",
        faq4a: "Sí, su privacidad es nuestra prioridad. Todo el procesamiento de video ocurre en su navegador web, lo que significa que sus videos nunca se envían ni se almacenan en nuestros servidores.",
        privacyPolicy: "Política de Privacidad",
        termsOfService: "Términos de Servicio",
        contactUs: "Contáctanos",
        footerRights: "Todos los derechos reservados.",
        videoMainTitle: "Herramienta de Recorte de Video Circular",
        videoMainIntro: "Cree videoclips circulares perfectos en línea. Grabe cualquier sección de su video dentro de un círculo, con un fondo transparente. Rápido y seguro.",
        uploadVideoCTA: "Arrastre y suelte su video aquí, o ",
        uploadClick: "clic para subir",
        uploadVideoFormats: "Admite MP4, WEBM, etc.",
        diameterLabel: "Diámetro del círculo:",
        videoControlsTitle: "Controles de Grabación",
        startRecording: "Iniciar Grabación",
        stopRecording: "Detener Grabación",
        downloadTitle: "Descargue su video",
        downloadVideo: "Descargar video transparente (.webm)",
        processing: "Procesando, por favor espere...",
        otherToolsTitle: "Otras Herramientas",
        tool1Title: "Convertidor de Imágenes en Línea",
        tool1Desc: "Convierta imágenes a diferentes formatos como PNG, JPG, WEBP, etc.",
        tool2Title: "Convertidor de Video a GIF",
        tool2Desc: "Convierta fácilmente sus videoclips en GIF animados.",
        tool3Title: "Cortador de Audio en Línea",
        tool3Desc: "Recorte o corte archivos de audio a la longitud perfecta.",
        tool4Title: "Grabador de Pantalla",
        tool4Desc: "Grabe su pantalla con audio para tutoriales o presentaciones."
    }
};
const flags = { en: '🇺🇸', es: '🇪🇸', pt: '🇧🇷', ru: '🇷🇺', de: '🇩🇪', fr: '🇫🇷', ja: '🇯🇵', ko: '🇰🇷', zh: '🇨🇳' };
let currentLang = 'en';
function updateNavLinks(e){document.querySelectorAll(".nav-link").forEach(t=>{const n=t.getAttribute("href").split("?")[0],o="/index.html"===n||"/"===n?"/":n;t.setAttribute("href",`${o}?lang=${e}`)})}
function setLanguage(e){const t=translations[e]?e:"en";currentLang=t;const n=translations[t]||translations.en;document.querySelectorAll("[data-lang-key]").forEach(e=>{const t=e.getAttribute("data-lang-key");n[t]&&(e.innerHTML=n[t])}),document.title=n.pageTitle,document.querySelector('meta[name="description"]').setAttribute("content",n.metaDescription),document.documentElement.lang=t;const o=document.getElementById("current-lang-flag");o&&(o.textContent=flags[t]);const a=document.getElementById("lang-switcher-menu");a&&a.classList.add("hidden","opacity-0","scale-95"),updateNavLinks(t)}
document.addEventListener("DOMContentLoaded",function(){const e=document.getElementById("lang-switcher-btn"),t=document.getElementById("lang-switcher-menu");let n="<div class='py-1' role='menu' aria-orientation='vertical' aria-labelledby='options-menu'>";const o={en:"English",es:"Español",pt:"Português",ru:"Русский",de:"Deutsch",fr:"Français",ja:"日本語",ko:"한국어",zh:"中文 (简体)"};for(const a in flags)n+=`<a href="?lang=${a}" class="flex items-center px-4 py-2 text-sm text-gray-700 hover:bg-gray-100" role="menuitem" data-lang="${a}"><span class="mr-3">${flags[a]}</span> ${o[a]}</a>`;n+="</div>",t.innerHTML=n,e.addEventListener("click",()=>{t.classList.toggle("hidden"),setTimeout(()=>{t.classList.toggle("opacity-0"),t.classList.toggle("scale-95")},10),e.setAttribute("aria-expanded",!t.classList.contains("hidden"))}),document.addEventListener("click",n=>{!e.contains(n.target)&&!t.contains(n.target)&&(t.classList.add("hidden","opacity-0","scale-95"),e.setAttribute("aria-expanded","false"))}),t.addEventListener("click",e=>{e.preventDefault();const n=e.target.closest("a");if(n&&n.dataset.lang){const e=n.dataset.lang;setLanguage(e);try{const t=new URL(window.location);t.searchParams.set("lang",e),window.history.pushState({},"",t)}catch(e){console.warn("Could not update URL with pushState.",e)}}});const a=new URLSearchParams(window.location.search),l=a.get("lang")||"en";setLanguage(l),document.getElementById("footer-year").textContent=(new Date).getFullYear();

// --- VIDEO CROPPER LOGIC ---
const videoUploadContainer = document.getElementById('video-upload-container');
const videoDropArea = document.getElementById('video-drop-area');
const videoFileInput = document.getElementById('video-file-input');
const videoEditorContainer = document.getElementById('video-editor-container');
const videoPlayer = document.getElementById('video-player');
const videoWrapper = document.querySelector('.canvas-wrapper');
const guideCanvas = document.getElementById('video-guide-canvas');
const guideCtx = guideCanvas.getContext('2d');
const diameterSlider = document.getElementById('diameter-slider');
const videoControlsContainer = document.getElementById('video-controls-container');
const startRecBtn = document.getElementById('start-rec-btn');
const stopRecBtn = document.getElementById('stop-rec-btn');
const videoResetBtn = document.getElementById('video-reset-btn');
const videoResetBtn2 = document.getElementById('video-reset-btn-2');
const videoResultContainer = document.getElementById('video-result-container');
const downloadVideoBtn = document.getElementById('download-video-btn');
const processingNotice = document.getElementById('video-processing-notice');

let videoFile = null;
let webmRecorder;
let webmChunks = [];
let animationFrameId;
let recordingTimerInterval = null;

let circlePosition = { x: 0, y: 0 };
let isDragging = false;
let dragStart = { x: 0, y: 0 };

function handleVideoUpload(file) {
    if (file && file.type.startsWith('video/')) {
        videoFile = file;
        videoPlayer.src = URL.createObjectURL(videoFile);
        videoUploadContainer.classList.add('hidden');
        videoEditorContainer.classList.remove('hidden');
        videoControlsContainer.classList.remove('hidden');
        videoResultContainer.classList.add('hidden');
    }
}

function drawVideoGuide() {
    const diam = parseInt(diameterSlider.value, 10);
    const radius = diam / 2;
    const centerX = (guideCanvas.width / 2) + circlePosition.x;
    const centerY = (guideCanvas.height / 2) + circlePosition.y;
    
    guideCtx.clearRect(0, 0, guideCanvas.width, guideCanvas.height);
    guideCtx.fillStyle = 'rgba(0, 0, 0, 0.5)';
    guideCtx.beginPath();
    guideCtx.rect(0, 0, guideCanvas.width, guideCanvas.height);
    guideCtx.arc(centerX, centerY, radius, 0, Math.PI * 2, true);
    guideCtx.fill();

    guideCtx.strokeStyle = 'rgba(255, 255, 255, 0.8)';
    guideCtx.lineWidth = 2;
    guideCtx.beginPath();
    guideCtx.arc(centerX, centerY, radius, 0, Math.PI * 2);
    guideCtx.stroke();
}

function formatTime(ms) {
    const seconds = Math.floor(ms / 1000);
    const ss = String(seconds % 60).padStart(2, '0');
    const mm = String(Math.floor(seconds / 60)).padStart(2, '0');
    return `${mm}:${ss}`;
}

videoPlayer.addEventListener('loadedmetadata', () => {
    const aspect = videoPlayer.videoWidth / videoPlayer.videoHeight;
    const containerWidth = videoPlayer.parentElement.clientWidth;
    guideCanvas.width = containerWidth;
    guideCanvas.height = containerWidth / aspect;
    diameterSlider.max = Math.min(guideCanvas.width, guideCanvas.height);
    diameterSlider.value = diameterSlider.max * 0.8;
    drawVideoGuide();
    videoPlayer.play();
});

function startRecording() {
    startRecBtn.classList.add('hidden');
    stopRecBtn.classList.remove('hidden');
    processingNotice.classList.add('hidden');
    videoResultContainer.classList.add('hidden');
    diameterSlider.disabled = true;

    const diam = parseInt(diameterSlider.value, 10);
    const transCanvas = document.createElement('canvas');
    transCanvas.width = diam;
    transCanvas.height = diam;
    const transCtx = transCanvas.getContext('2d');

    function renderLoop() {
        const scale = videoPlayer.videoWidth / guideCanvas.width;
        const radiusInVideoPixels = (diam / 2) * scale;
        const centerXInVideoPixels = (videoPlayer.videoWidth / 2) + (circlePosition.x * scale);
        const centerYInVideoPixels = (videoPlayer.videoHeight / 2) + (circlePosition.y * scale);
        const sx = centerXInVideoPixels - radiusInVideoPixels;
        const sy = centerYInVideoPixels - radiusInVideoPixels;
        const sWidth = 2 * radiusInVideoPixels;
        const sHeight = sWidth;
        transCtx.clearRect(0, 0, diam, diam);
        transCtx.save();
        transCtx.beginPath();
        transCtx.arc(diam / 2, diam / 2, diam / 2, 0, Math.PI * 2);
        transCtx.clip();
        transCtx.drawImage(videoPlayer, sx, sy, sWidth, sHeight, 0, 0, diam, diam);
        transCtx.restore();
        animationFrameId = requestAnimationFrame(renderLoop);
    }

    let audioStream = null;
    if (videoPlayer.mozCaptureStream) {
        audioStream = videoPlayer.mozCaptureStream().getAudioTracks().length > 0 ? new MediaStream(videoPlayer.mozCaptureStream().getAudioTracks()) : null;
    } else if (videoPlayer.captureStream) {
         audioStream = videoPlayer.captureStream().getAudioTracks().length > 0 ? new MediaStream(videoPlayer.captureStream().getAudioTracks()) : null;
    }
    const transStream = transCanvas.captureStream(30);
    if(audioStream && audioStream.getAudioTracks().length > 0) {
      const transAudioTrack = audioStream.getAudioTracks()[0].clone();
      transStream.addTrack(transAudioTrack);
    }
    webmRecorder = new MediaRecorder(transStream, { mimeType: 'video/webm; codecs=vp9,opus' });
    webmChunks = [];
    webmRecorder.ondataavailable = e => webmChunks.push(e.data);

    webmRecorder.onstop = () => {
        const blob = new Blob(webmChunks, { type: 'video/webm' });
        const url = URL.createObjectURL(blob);
        const originalFilename = videoFile.name;
        const baseFilename = originalFilename.lastIndexOf('.') > 0 ? originalFilename.substring(0, originalFilename.lastIndexOf('.')) : originalFilename;
        downloadVideoBtn.href = url;
        downloadVideoBtn.download = `${baseFilename}-circle.webm`;
    };
    
    videoPlayer.pause();
    videoPlayer.currentTime = 0;
    webmRecorder.start();
    videoPlayer.play();
    renderLoop();

    const startTime = Date.now();
    const originalStopText = translations[currentLang].stopRecording;
    recordingTimerInterval = setInterval(() => {
        const elapsedTime = Date.now() - startTime;
        stopRecBtn.textContent = `${originalStopText} (${formatTime(elapsedTime)})`;
    }, 1000);
}

function stopRecording() {
    if (recordingTimerInterval) {
        clearInterval(recordingTimerInterval);
        recordingTimerInterval = null;
    }
    stopRecBtn.textContent = translations[currentLang].stopRecording;

    if(videoPlayer.played) videoPlayer.pause();
    if (webmRecorder && webmRecorder.state !== "inactive") webmRecorder.stop();
    cancelAnimationFrame(animationFrameId);
    stopRecBtn.classList.add('hidden');
    startRecBtn.classList.remove('hidden');
    videoControlsContainer.classList.add('hidden');
    videoResultContainer.classList.remove('hidden');
    processingNotice.classList.remove('hidden');
    setTimeout(() => processingNotice.classList.add('hidden'), 2000);
    diameterSlider.disabled = false;
}

function resetVideoTool() {
    stopRecording();
    if(videoPlayer.src) {
        URL.revokeObjectURL(videoPlayer.src);
        videoPlayer.src = "";
    }
    videoFile = null;
    videoFileInput.value = "";
    videoUploadContainer.classList.remove('hidden');
    videoEditorContainer.classList.add('hidden');
    videoControlsContainer.classList.add('hidden');
    videoResultContainer.classList.add('hidden');
    if (downloadVideoBtn.href) URL.revokeObjectURL(downloadVideoBtn.href);
    downloadVideoBtn.href = "#";
    diameterSlider.disabled = false;
    circlePosition = { x: 0, y: 0 };
}

videoPlayer.onended = stopRecording;
videoDropArea.addEventListener('click', () => videoFileInput.click());
videoDropArea.addEventListener('keydown', e => { if (e.key === 'Enter' || e.key === ' ') videoFileInput.click(); });
videoFileInput.addEventListener('change', (e) => handleVideoUpload(e.target.files[0]));
videoDropArea.addEventListener('dragover', e => { e.preventDefault(); e.stopPropagation(); videoDropArea.classList.add('drag-over'); });
videoDropArea.addEventListener('dragleave', e => { e.preventDefault(); e.stopPropagation(); videoDropArea.classList.remove('drag-over'); });
videoDropArea.addEventListener('drop', e => { e.preventDefault(); e.stopPropagation(); videoDropArea.classList.remove('drag-over'); handleVideoUpload(e.dataTransfer.files[0]); });

diameterSlider.addEventListener('input', () => {
    drawVideoGuide();
});

startRecBtn.addEventListener('click', startRecording);
stopRecBtn.addEventListener('click', stopRecording);
videoResetBtn.addEventListener('click', resetVideoTool);
videoResetBtn2.addEventListener('click', resetVideoTool);

function getMousePos(canvas, evt) {
    const rect = canvas.getBoundingClientRect();
    const clientX = evt.clientX || (evt.touches && evt.touches[0].clientX);
    const clientY = evt.clientY || (evt.touches && evt.touches[0].clientY);
    return {
        x: clientX - rect.left,
        y: clientY - rect.top
    };
}

function handleDragStart(evt) {
    evt.preventDefault();
    const clickPos = getMousePos(guideCanvas, evt);
    const radius = parseInt(diameterSlider.value, 10) / 2;
    const centerX = (guideCanvas.width / 2) + circlePosition.x;
    const centerY = (guideCanvas.height / 2) + circlePosition.y;
    const dx = clickPos.x - centerX;
    const dy = clickPos.y - centerY;
    if (dx * dx + dy * dy <= radius * radius) {
        isDragging = true;
        dragStart = getMousePos(guideCanvas, evt);
        videoWrapper.classList.add('is-dragging');
    }
}

function handleDragMove(evt) {
    if (!isDragging) return;
    evt.preventDefault();
    const pos = getMousePos(guideCanvas, evt);
    const dx = pos.x - dragStart.x;
    const dy = pos.y - dragStart.y;
    
    circlePosition.x += dx;
    circlePosition.y += dy;

    const radius = parseInt(diameterSlider.value, 10) / 2;
    const maxX = (guideCanvas.width / 2) - radius;
    const maxY = (guideCanvas.height / 2) - radius;
    
    circlePosition.x = Math.max(-maxX, Math.min(maxX, circlePosition.x));
    circlePosition.y = Math.max(-maxY, Math.min(maxY, circlePosition.y));
    
    dragStart = pos;
    drawVideoGuide();
}

function handleDragEnd() {
    isDragging = false;
    videoWrapper.classList.remove('is-dragging');
}

guideCanvas.addEventListener('mousemove', (evt) => {
    if(isDragging) return;
    const pos = getMousePos(guideCanvas, evt);
    const radius = parseInt(diameterSlider.value, 10) / 2;
    const centerX = (guideCanvas.width / 2) + circlePosition.x;
    const centerY = (guideCanvas.height / 2) + circlePosition.y;
    const dx = pos.x - centerX;
    const dy = pos.y - centerY;
    if (dx * dx + dy * dy <= radius * radius) {
        guideCanvas.style.cursor = 'move';
    } else {
        guideCanvas.style.cursor = 'default';
    }
});

guideCanvas.addEventListener('mouseleave', () => {
    guideCanvas.style.cursor = 'default';
});

guideCanvas.addEventListener('mousedown', handleDragStart);
guideCanvas.addEventListener('touchstart', handleDragStart, { passive: false });

document.addEventListener('mousemove', handleDragMove);
document.addEventListener('touchmove', handleDragMove, { passive: false });

document.addEventListener('mouseup', handleDragEnd);
document.addEventListener('touchend', handleDragEnd);

});